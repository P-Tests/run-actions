name: Puppeteer DocServer test
run-name: Puppeteer DocServer test - ${{ github.event.inputs.url }}

on:
  workflow_dispatch:
    inputs:
      url:
        description: Stand to test
        required: true
        default: release
        type: choice
        options:
        - release
        - hotfix
        - develop
      chunk_size:
        description: 'Number of tests per chunk'
        required: false
        default: '1000'
        type: string

jobs:
  prepare:
    name: Prepare Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      num_chunks: ${{ steps.set-matrix.outputs.num_chunks }}
      chunk_size: ${{ steps.set-matrix.outputs.chunk_size }}
      rp_launch_ids: ${{ steps.create-launches.outputs.launch_ids }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Checkout main repository Dep.Tests
        uses: actions/checkout@v4
        with:
          repository: ONLYOFFICE-data/Dep.Tests
          path: Dep.Tests
          token: ${{ secrets.READ_PAT }}

      - name: Setup Git
        shell: bash
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git config --global url."https://${{ secrets.READ_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Init specific submodule
        shell: bash
        run: |
          cd Dep.Tests
          git submodule update --init --depth 1 puppeteer/files

      - name: Install dependencies
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine
          npm install

      - name: Count tests and generate matrix
        id: set-matrix
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine

          CHUNK_SIZE="${{ github.event.inputs.chunk_size || '1000' }}"

          OUTPUT=$(python run.py --providers example --count-tests --chunk-size $CHUNK_SIZE)

          echo "Count tests output:"
          echo "$OUTPUT"

          NUM_CHUNKS=$(echo "$OUTPUT" | grep "num_chunks=" | cut -d'=' -f2)
          MATRIX=$(echo "$OUTPUT" | grep "matrix=" | cut -d'=' -f2-)

          echo "num_chunks=$NUM_CHUNKS" >> $GITHUB_OUTPUT
          echo "chunk_size=$CHUNK_SIZE" >> $GITHUB_OUTPUT
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          echo "Number of chunks: $NUM_CHUNKS"
          echo "Chunk size: $CHUNK_SIZE"
          echo "Matrix: $MATRIX"

      - name: Configure Report Portal
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/tools/report_portal/config.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.api_key = '${{ secrets.REPORT_KEY }}';
            config.project_name = 'docsserver';

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Set URL in configs
        shell: bash
        run: |
          URL_INPUT="${{ github.event.inputs.url }}"

          if [[ "$URL_INPUT" == "release" ]]; then
            URL="${{ secrets.URL_RELEASE }}"
          elif [[ "$URL_INPUT" == "hotfix" ]]; then
            URL="${{ secrets.URL_HOTFIX }}"
          elif [[ "$URL_INPUT" == "develop" ]]; then
            URL="${{ secrets.URL_DEVELOP }}"
          else
            URL="$URL_INPUT"
          fi

          echo "Setting URL in all configs: $URL"

          # Set URL in all Puppeteer config files
          for config_file in Dep.Tests/puppeteer/config_chrome_win.json Dep.Tests/puppeteer/config_chrome_linux.json Dep.Tests/puppeteer/config_chrome_mac.json; do
            node -e "
              const fs = require('fs');
              const config = JSON.parse(fs.readFileSync('$config_file', 'utf8'));
              let url = '$URL';
              if (!url.endsWith('/example')) {
                url = url + '/example';
              }
              config.testOptions.url = url;
              fs.writeFileSync('$config_file', JSON.stringify(config, null, 2));
            "
          done

      - name: Create Report Portal Launches
        id: create-launches
        shell: bash
        run: |
          cd Dep.Tests/tools/report_portal

          node -e "
            const { execSync } = require('child_process');
            const fs = require('fs');

            const osList = [
              { name: 'windows', displayName: 'Windows', configFile: 'config_chrome_win.json' },
              { name: 'linux', displayName: 'Linux', configFile: 'config_chrome_linux.json' },
              { name: 'macos', displayName: 'macOS', configFile: 'config_chrome_mac.json' }
            ];

            const launchIds = {};

            for (const os of osList) {
              const launchName = \`Github Action \${os.displayName} Tests\`;
              console.log(\`Creating launch for \${os.name}...\`);

              const configPath = \`../../puppeteer/\${os.configFile}\`;

              try {
                const output = execSync(
                  \`python manage_launch.py create --name \"\${launchName}\" --config-puppeteer \${configPath} --provider example --platform \${os.name}\`,
                  { encoding: 'utf-8' }
                );

                console.log(output);

                const match = output.match(/LAUNCH_ID=(.+)/);
                if (!match) {
                  throw new Error(\`Failed to extract launch ID for \${os.name}\`);
                }

                const launchId = match[1].trim();
                launchIds[os.name] = launchId;
                console.log(\`Created Report Portal launch for \${os.name}: \${launchId}\`);
              } catch (error) {
                console.error(\`ERROR: Failed to create Report Portal launch for \${os.name}\`);
                console.error(error.message);
                process.exit(1);
              }
            }

            const launchIdsJson = JSON.stringify(launchIds);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, \`launch_ids=\${launchIdsJson}\n\`);
            console.log(\`All Report Portal launches created: \${launchIdsJson}\`);
          "

  run-tests-windows:
    name: Run Tests - Windows - Chunk ${{ matrix.chunk }}
    needs: prepare
    runs-on: windows-latest
    strategy:
      matrix:
        chunk: ${{ fromJson(needs.prepare.outputs.matrix).chunk }}
      fail-fast: false
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Checkout main repository Dep.Tests
        uses: actions/checkout@v4
        with:
          repository: ONLYOFFICE-data/Dep.Tests
          path: Dep.Tests
          token: ${{ secrets.READ_PAT }}

      - name: Setup Git
        shell: bash
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git config --global url."https://${{ secrets.READ_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Init specific submodule
        shell: bash
        run: |
          cd Dep.Tests
          git submodule update --init --depth 1 puppeteer/files

      - name: Set URL in config
        shell: bash
        run: |
          URL_INPUT="${{ github.event.inputs.url }}"

          if [[ "$URL_INPUT" == "release" ]]; then
            URL="${{ secrets.URL_RELEASE }}"
          elif [[ "$URL_INPUT" == "hotfix" ]]; then
            URL="${{ secrets.URL_HOTFIX }}"
          elif [[ "$URL_INPUT" == "develop" ]]; then
            URL="${{ secrets.URL_DEVELOP }}"
          else
            URL="$URL_INPUT"
          fi

          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/puppeteer/config_chrome_win.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            let url = '$URL';
            if (!url.endsWith('/example')) {
              url = url + '/example';
            }
            config.testOptions.url = url;

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Configure Report Portal
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/tools/report_portal/config.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.api_key = '${{ secrets.REPORT_KEY }}';
            config.project_name = 'docsserver';

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Install dependencies
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine
          npm install

      - name: Determine Report Portal Launch ID
        shell: bash
        run: |
          LAUNCH_ID="${{ fromJSON(needs.prepare.outputs.rp_launch_ids)['windows'] }}"

          if [ -z "$LAUNCH_ID" ]; then
            echo "ERROR: No launch ID found for windows"
            exit 1
          fi

          echo "RP_LAUNCH_ID=$LAUNCH_ID" >> $GITHUB_ENV
          echo "Using Report Portal launch ID for windows: $LAUNCH_ID"

      - name: Run tests chunk
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine

          CHUNK_SIZE="${{ needs.prepare.outputs.chunk_size }}"
          CHUNK_ID="${{ matrix.chunk }}"

          python run.py \
            --providers example \
            --chunk-id $CHUNK_ID \
            --chunk-size $CHUNK_SIZE \
            --disable_animation \
            --config_params puppeteerOptions.headless=true \
            --connect_portal \
            --rp-launch-id "$RP_LAUNCH_ID" \
            --rp-no-finish

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out-windows-example-chunk-${{ matrix.chunk }}
          path: Dep.Tests/puppeteer/out

  run-tests-linux:
    name: Run Tests - Linux - Chunk ${{ matrix.chunk }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: ${{ fromJson(needs.prepare.outputs.matrix).chunk }}
      fail-fast: false
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Checkout main repository Dep.Tests
        uses: actions/checkout@v4
        with:
          repository: ONLYOFFICE-data/Dep.Tests
          path: Dep.Tests
          token: ${{ secrets.READ_PAT }}

      - name: Setup Git
        shell: bash
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git config --global url."https://${{ secrets.READ_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Init specific submodule
        shell: bash
        run: |
          cd Dep.Tests
          git submodule update --init --depth 1 puppeteer/files

      - name: Set URL in config
        shell: bash
        run: |
          URL_INPUT="${{ github.event.inputs.url }}"

          if [[ "$URL_INPUT" == "release" ]]; then
            URL="${{ secrets.URL_RELEASE }}"
          elif [[ "$URL_INPUT" == "hotfix" ]]; then
            URL="${{ secrets.URL_HOTFIX }}"
          elif [[ "$URL_INPUT" == "develop" ]]; then
            URL="${{ secrets.URL_DEVELOP }}"
          else
            URL="$URL_INPUT"
          fi

          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/puppeteer/config_chrome_linux.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            let url = '$URL';
            if (!url.endsWith('/example')) {
              url = url + '/example';
            }
            config.testOptions.url = url;

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Configure Report Portal
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/tools/report_portal/config.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.api_key = '${{ secrets.REPORT_KEY }}';
            config.project_name = 'docsserver';

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Set headless mode for linux
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/puppeteer/config_chrome_linux.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.puppeteerOptions.headless = true;

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Install dependencies
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine
          npm install

      - name: Configure Puppeteer sandbox
        shell: bash
        run: |
          CHROME_VERSION=$(ls ~/.cache/puppeteer/chrome/linux-* -d 2>/dev/null | head -n 1 | xargs basename 2>/dev/null || echo "")
          if [ -z "$CHROME_VERSION" ]; then
            echo "Chrome not installed yet, will be configured after npm install"
          else
            cd ~/.cache/puppeteer/chrome/$CHROME_VERSION/chrome-linux64/
            sudo chown root:root chrome_sandbox
            sudo chmod 4755 chrome_sandbox
            sudo cp -p chrome_sandbox /usr/local/sbin/chrome-devel-sandbox
          fi
          echo "CHROME_DEVEL_SANDBOX=/usr/local/sbin/chrome-devel-sandbox" >> $GITHUB_ENV

      - name: Determine Report Portal Launch ID
        shell: bash
        run: |
          LAUNCH_ID="${{ fromJSON(needs.prepare.outputs.rp_launch_ids)['linux'] }}"

          if [ -z "$LAUNCH_ID" ]; then
            echo "ERROR: No launch ID found for linux"
            exit 1
          fi

          echo "RP_LAUNCH_ID=$LAUNCH_ID" >> $GITHUB_ENV
          echo "Using Report Portal launch ID for linux: $LAUNCH_ID"

      - name: Run tests chunk
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine

          CHUNK_SIZE="${{ needs.prepare.outputs.chunk_size }}"
          CHUNK_ID="${{ matrix.chunk }}"

          python run.py \
            --providers example \
            --chunk-id $CHUNK_ID \
            --chunk-size $CHUNK_SIZE \
            --disable_animation \
            --config_params puppeteerOptions.headless=true \
            --connect_portal \
            --rp-launch-id "$RP_LAUNCH_ID" \
            --rp-no-finish

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out-linux-example-chunk-${{ matrix.chunk }}
          path: Dep.Tests/puppeteer/out

  run-tests-macos:
    name: Run Tests - macOS - Chunk ${{ matrix.chunk }}
    needs: prepare
    runs-on: macos-latest
    strategy:
      matrix:
        chunk: ${{ fromJson(needs.prepare.outputs.matrix).chunk }}
      fail-fast: false
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Checkout main repository Dep.Tests
        uses: actions/checkout@v4
        with:
          repository: ONLYOFFICE-data/Dep.Tests
          path: Dep.Tests
          token: ${{ secrets.READ_PAT }}

      - name: Setup Git
        shell: bash
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git config --global url."https://${{ secrets.READ_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Init specific submodule
        shell: bash
        run: |
          cd Dep.Tests
          git submodule update --init --depth 1 puppeteer/files

      - name: Set URL in config
        shell: bash
        run: |
          URL_INPUT="${{ github.event.inputs.url }}"

          if [[ "$URL_INPUT" == "release" ]]; then
            URL="${{ secrets.URL_RELEASE }}"
          elif [[ "$URL_INPUT" == "hotfix" ]]; then
            URL="${{ secrets.URL_HOTFIX }}"
          elif [[ "$URL_INPUT" == "develop" ]]; then
            URL="${{ secrets.URL_DEVELOP }}"
          else
            URL="$URL_INPUT"
          fi

          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/puppeteer/config_chrome_mac.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            let url = '$URL';
            if (!url.endsWith('/example')) {
              url = url + '/example';
            }
            config.testOptions.url = url;

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Configure Report Portal
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/tools/report_portal/config.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.api_key = '${{ secrets.REPORT_KEY }}';
            config.project_name = 'docsserver';

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Install dependencies
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine
          npm install

      - name: Determine Report Portal Launch ID
        shell: bash
        run: |
          LAUNCH_ID="${{ fromJSON(needs.prepare.outputs.rp_launch_ids)['macos'] }}"

          if [ -z "$LAUNCH_ID" ]; then
            echo "ERROR: No launch ID found for macos"
            exit 1
          fi

          echo "RP_LAUNCH_ID=$LAUNCH_ID" >> $GITHUB_ENV
          echo "Using Report Portal launch ID for macos: $LAUNCH_ID"

      - name: Run tests chunk
        shell: bash
        run: |
          cd Dep.Tests/puppeteer/engine

          CHUNK_SIZE="${{ needs.prepare.outputs.chunk_size }}"
          CHUNK_ID="${{ matrix.chunk }}"

          python run.py \
            --providers example \
            --chunk-id $CHUNK_ID \
            --chunk-size $CHUNK_SIZE \
            --disable_animation \
            --config_params puppeteerOptions.headless=true \
            --connect_portal \
            --rp-launch-id "$RP_LAUNCH_ID" \
            --rp-no-finish

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out-macos-example-chunk-${{ matrix.chunk }}
          path: Dep.Tests/puppeteer/out

  finalize:
    name: Finalize Launch - ${{ matrix.os.name }}
    needs: [prepare, run-tests-windows, run-tests-linux, run-tests-macos]
    runs-on: ubuntu-latest
    if: always()
    strategy:
      matrix:
        os:
          - name: windows
            display_name: Windows
          - name: linux
            display_name: Linux
          - name: macos
            display_name: macOS

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Checkout main repository Dep.Tests
        uses: actions/checkout@v4
        with:
          repository: ONLYOFFICE-data/Dep.Tests
          path: Dep.Tests
          token: ${{ secrets.READ_PAT }}

      - name: Configure Report Portal
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const filePath = 'Dep.Tests/tools/report_portal/config.json';
            const config = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            config.api_key = '${{ secrets.REPORT_KEY }}';
            config.project_name = 'docsserver';

            fs.writeFileSync(filePath, JSON.stringify(config, null, 2));
          "

      - name: Determine final status
        id: status
        shell: bash
        run: |
          if [[ "${{ matrix.os.name }}" == "windows" ]]; then
            JOB_RESULT="${{ needs.run-tests-windows.result }}"
          elif [[ "${{ matrix.os.name }}" == "linux" ]]; then
            JOB_RESULT="${{ needs.run-tests-linux.result }}"
          else
            JOB_RESULT="${{ needs.run-tests-macos.result }}"
          fi

          echo "Job result for ${{ matrix.os.name }}: $JOB_RESULT"

          if [[ "$JOB_RESULT" == "success" ]]; then
            echo "status=PASSED" >> $GITHUB_OUTPUT
          else
            echo "status=FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Finish Report Portal Launch
        shell: bash
        run: |
          cd Dep.Tests/tools/report_portal

          LAUNCH_ID="${{ fromJSON(needs.prepare.outputs.rp_launch_ids)[matrix.os.name] }}"

          if [ -z "$LAUNCH_ID" ]; then
            echo "ERROR: No launch ID for ${{ matrix.os.name }}"
            exit 1
          fi

          STATUS="${{ steps.status.outputs.status }}"

          echo "Finishing Report Portal launch for ${{ matrix.os.name }}: $LAUNCH_ID with status: $STATUS"

          python manage_launch.py finish \
            --launch-id "$LAUNCH_ID" \
            --status "$STATUS"

          echo "Report Portal launch for ${{ matrix.os.name }} finished successfully"
